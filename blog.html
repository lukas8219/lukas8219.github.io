<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Lucas Weis Polesello | SRE &amp; Sr Software Engineer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lukas8219.github.io/img/obsidiosaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lukas8219.github.io/img/obsidiosaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lukas8219.github.io/blog"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Lucas Weis Polesello | SRE &amp; Sr Software Engineer"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="https://github.com/lukas8219.png"><link data-rh="true" rel="canonical" href="https://lukas8219.github.io/blog"><link data-rh="true" rel="alternate" href="https://lukas8219.github.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://lukas8219.github.io/blog" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RE0I3LUV18-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Lucas Weis Polesello | SRE &amp; Sr Software Engineer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Lucas Weis Polesello | SRE &amp; Sr Software Engineer Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Lucas Weis Polesello | SRE &amp; Sr Software Engineer" href="/opensearch.xml">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.5eac164b.css">
<link rel="preload" href="/assets/js/runtime~main.4932596a.js" as="script">
<link rel="preload" href="/assets/js/main.846843c0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://github.com/lukas8219.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://github.com/lukas8219.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">LWP Softwares</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/learn-in-public/Engineering/AMQP/AMQP Protocol - Model and Protocol">Learn in Public</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/lukas8219/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/04/06/data-strucutres-applicability">DataStructure Applicabilities - Bitmap and Access Control: How to scale notifications with ACL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/31/network-bandwidth-reduction">The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/31/open-source-tales-1">Open Source Tales #1: WebSocket Operator</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/03/15/redis-is-more-than-cache-data-reference">Redis is more than a Cache - Data Reference</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/03/15/redis-is-more-than-cache-job-delay">Redis is more than a Cache - Delaying Jobs</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2025/04/06/data-strucutres-applicability">DataStructure Applicabilities - Bitmap and Access Control: How to scale notifications with ACL</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-06T00:00:00.000Z" itemprop="datePublished">April 6, 2025</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>As engineers we are very used to manipulating data in well-know structures like arrays, queues, sets and maps as they solve day-to-day issues - like when you need to manipulate relationships from database on the client-side, you use Sets/Maps to prevent <code>O(nˆ2)</code>searches.</p><p>But one of the not-so common data structures is the Bitmap - being very math-focused and tailored for certain scenarios - it&#x27;s usually forgotten.</p><p>Today we are going to showcase one scenario where it might be interesting to use it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-with-access-control">The Problem with Access Control<a href="#the-problem-with-access-control" class="hash-link" aria-label="Direct link to The Problem with Access Control" title="Direct link to The Problem with Access Control">​</a></h2><p>In many SaaS platforms - the ACL model usually revolves around <strong>many-to-many</strong> relationships, as example - imagine you have a software that solves for real-time communication such as Slack but give it a bit more of <strong>spiciness</strong> (<em>as if Slack needs it?</em>) - give it 1 more layer of control.</p><p>You would have an User U that belongs to Groups G. And each Group has it&#x27;s own set of Teams T. Each sent message for a Team T should be Broadcasted to all online Users that have access to Team T.</p><p>With this - you do have a problem where you need to ensure that messages CANNOT be routed to wrong recipients and other Teams may join the same conversation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge-is-about-scale">The Challenge Is About Scale<a href="#the-challenge-is-about-scale" class="hash-link" aria-label="Direct link to The Challenge Is About Scale" title="Direct link to The Challenge Is About Scale">​</a></h3><p>You can scale this by simply doing database queries - up to a certain scale this is fairly simple. A query would hardly reach &gt;50ms if well-indexed. Even if it was poorly optimized wouldn&#x27;t be a huge problem.
Nonetheless, maybe even the amount of  notifications is not a problem!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but-we-like-to-pretend-windmills-are-dragons">But We Like To Pretend Windmills are Dragons<a href="#but-we-like-to-pretend-windmills-are-dragons" class="hash-link" aria-label="Direct link to But We Like To Pretend Windmills are Dragons" title="Direct link to But We Like To Pretend Windmills are Dragons">​</a></h3><p>The real challenge is:
<code>What if, either lucky or the biggest salesman ever, your company reaches a huge milestone and now scale hits upon the backdoor</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-scenario">The Scenario:<a href="#the-scenario" class="hash-link" aria-label="Direct link to The Scenario:" title="Direct link to The Scenario:">​</a></h3><p>Out of a sudden now you are handling 30K+ notifications per second. Your engineering team, knowing the domain of the product, designed almost all modeling and infrastructure with this in mind. But yet hammering the database 30K+ times per second is far from ideal - although injecting<code>$$$</code> solves it - we like to pretend people care for green solutions in this blog.</p><p>At a certain day - a Slack thread arrives:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 1: Since the last Go-live our database system is just crawling man... I don&#x27;t know how long we can sustain this.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 2: Yeah... We jumped from 10K Messages/Sec to more than 30K - no wonder it just got hammered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 1: I think it&#x27;s time to optimize this but that might be hard - maybe some caching layer?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 2: Yeah, caching could be the way - but how?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 1: I have no idea to be honest. it might be too much data for Redis?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engineer 3: Yo I am pretty sure some has solved this...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CTO: I think we can use Bitmaps for that ?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bitmaps-and-access-control">BitMaps and Access Control<a href="#bitmaps-and-access-control" class="hash-link" aria-label="Direct link to BitMaps and Access Control" title="Direct link to BitMaps and Access Control">​</a></h3><p>Finally we reached the main part of this article - <strong>Bitmaps</strong> - are data structures specialized in binary operations - being fast and space-efficient.
By such they efficiently tell us wether something is ON/OFF or TRUE/FALSE.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-design">The Design<a href="#the-design" class="hash-link" aria-label="Direct link to The Design" title="Direct link to The Design">​</a></h2><p>Each Tenant would have all of its Teams lay&#x27;ed out in Redis Bitmaps such as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">teams:&lt;tenantId&gt;:&lt;tid&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">online-users:&lt;tenantId&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>(Assuming you have de-normalized this relations due to it&#x27;s read-pattern)</strong>
Instead of doing:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    groups ug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">teams </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">list </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> teams</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> ug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tenantId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">tenantId</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You would simply use a small LuaScript:</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">local tenantId = ARGV[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local tmp_or_key = &#x27;tmp:teams&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local notify_key = &#x27;tmp:notification&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local online_key = &#x27;online-users:&#x27; + tenantId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Store tmp key for all SET bitmaps using OR operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;BITOP&#x27;, &#x27;OR&#x27;, tmp_or_key, unpack(KEYS))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Store the key with the </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;BITOP&#x27;, &#x27;AND&#x27;, notify_key, tmp_or_key, online_key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Extract those Ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local max_index = redis.call(&#x27;STRLEN&#x27;, notify_key) * 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local notified_users = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for i = 0, max_index - 1 do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  local bit = redis.call(&#x27;GETBIT&#x27;, notify_key, i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if bit == 1 then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    table.insert(notified_users, i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;DEL&#x27;, tmp_or_key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return notified_users</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-outcome">The Outcome<a href="#the-outcome" class="hash-link" aria-label="Direct link to The Outcome" title="Direct link to The Outcome">​</a></h3><p>So revisiting what changed in the infrastructure:</p><p>Before, you were doing 30K database operations - which include all the way from Parsing, Planning, Optimizing, Checking Buffer Cache - maybe reading from Disk. It&#x27;s even worse, if your database is write-specialized like those with LSM Storage Engines.</p><p>Instead of doing all of this: You are now flipping bits in a pretty-much efficient CPU cache.</p><p>The current scenario?</p><ul><li>Your database is free of abusive reads.</li><li>It can focus on the write-heavy nature of Chat systems</li><li>Notifications are now even faster - what took (luckily) under 50ms is now under 1ms</li><li>Downgrade that database man and save some money!</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="take-aways-points-notes">Take Aways Points Notes<a href="#take-aways-points-notes" class="hash-link" aria-label="Direct link to Take Aways Points Notes" title="Direct link to Take Aways Points Notes">​</a></h3><ol><li>You might be asking yourself if you couldn&#x27;t do so with normal <code>Sets</code>. And the answer is: <code>Yes</code>.
The trade-offs? <code>RAM Storage($$$), CPU Performance and Latency overall</code> </li><li>You could easily fit more than 10 Million Users within less than 5GB of data using <a href="https://roaringbitmap.org/" target="_blank" rel="noopener noreferrer">Roaring Bitmaps</a>!</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/websocket">websocket</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/notifications">notifications</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/datastructures">datastructures</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bitmaps">bitmaps</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/readisismorethanacache">readisismorethanacache</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2025/03/31/network-bandwidth-reduction">The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-31T00:00:00.000Z" itemprop="datePublished">March 31, 2025</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Back in 2022 <a href="https://www.lumahealth.io/" target="_blank" rel="noopener noreferrer">@Luma</a> had a major outage which caused hours of downtime, angry customers and lots of engineering efforts to return the product back to normal.
One of the discoveries made at that time was a hard truth: <code>we modeled our internal IAM object poorly</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="inb4-phi">inb4: PHI<a href="#inb4-phi" class="hash-link" aria-label="Direct link to inb4: PHI" title="Direct link to inb4: PHI">​</a></h2><p>On the HealthCare Tech Industry - and outside of it - Patient Health Information (PHI) is of major importance. When applied to Luma&#x27;s platform - being <em>very</em> brief - states that patient&#x27;s data should belong only to facilities that they had interaction with/allowed them to have.
This is to protect patient&#x27;s health information and access to their data. It&#x27;s a US-government enforced law.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iam-model">IAM Model<a href="#iam-model" class="hash-link" aria-label="Direct link to IAM Model" title="Direct link to IAM Model">​</a></h2><p>Our IAM model is something called <code>session</code> object - a pretty simple concept - it concentrates the user&#x27;s token, settings, groups, facilities and more metadata about itself. We use this <code>session</code> throughout all backend components of Luma to properly apply this PHI filtering rule.
One of the bad decision back then was to simply pull all <code>facilities</code> and <code>groups</code> inside a JSON object and cache it. But then you would probably ask...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="whats-the-problem-of-it">What&#x27;s the problem of it?<a href="#whats-the-problem-of-it" class="hash-link" aria-label="Direct link to What&#x27;s the problem of it?" title="Direct link to What&#x27;s the problem of it?">​</a></h3><p>When Luma grown it&#x27;s scale - we started onboarding bigger and bigger customers - with their own setup of account leading to N different use-cases.
Summing up some very creative account setups and huge customers - we ended up creating something unexpected - <code>session</code> object storing up to 2.6MB of pure JSON text.</p><p>And yes, you did read it right - an entire PDF!!</p><p>Now <code>imagine that for each job, we actually pulled cached sessions up to 100x - or even more. Luma produces average of 2K jobs per second spiking up to 10K</code></p><p><strong>That&#x27;s <code>ALOT</code> of Network usage.</strong> - easily surpassing 2GB per second - aka more than 15Gbps.
For reference - <a href="https://instances.vantage.sh/aws/elasticache/cache.m6g.8xlarge" target="_blank" rel="noopener noreferrer">cache.m6g.8xlarge</a> which is a fair-sized cache instance has this bandwidth.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure-impact">Infrastructure Impact<a href="#infrastructure-impact" class="hash-link" aria-label="Direct link to Infrastructure Impact" title="Direct link to Infrastructure Impact">​</a></h3><p>All of a sudden Luma has this scenario:</p><ul><li>Slow and unstable HTTP APIs</li><li>Had to oversize more than usual to handle same load - a very low overall ~400RPS</li><li>Had to split our Broker instance into smaller and focused one&#x27;s</li><li>Had to increase our cache size</li><li>We had to create one thing called <code>pubsub-service</code> (yes and yes, no bueno) to offload services of slow publishes.</li><li>With this - we also created a <code>jobless</code> feature which forced backend components to publish only the <code>jobId</code> and route the job content itself via Redis.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-business-impact-money-being-thrown-away-and-unsatisfied-customers">The Business Impact? Money being thrown away and unsatisfied customers<a href="#the-business-impact-money-being-thrown-away-and-unsatisfied-customers" class="hash-link" aria-label="Direct link to The Business Impact? Money being thrown away and unsatisfied customers" title="Direct link to The Business Impact? Money being thrown away and unsatisfied customers">​</a></h2><p>Given it&#x27;s mission-critical importance of <code>Session</code> - the risks were just too high until 1st of March 2025.
After good months of investigation, searching code, trying to run AST analysis (codemod) in almost the entire codebase and libraries - it sounded like we had a solution in-mind.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data">A simple feature flag - that would do <code>Query.select(_id)</code> when querying <code>Groups</code> - building the session with less data.<a href="#a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data" class="hash-link" aria-label="Direct link to a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data" title="Direct link to a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data">​</a></h4><p>Although simple and sustained by a lot of research we were still cautious by setting up lots of product metrics and log metrics to understand wether rolled customers would have negative impact - like messaging not going out, notifications being missed or even worse - entire product breakdown.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rollout-and-implementation">Rollout and Implementation<a href="#rollout-and-implementation" class="hash-link" aria-label="Direct link to Rollout and Implementation" title="Direct link to Rollout and Implementation">​</a></h3><ul><li>We needed to ensure our libraries were at least a certain version</li><li>Enable flag for each customer tenant <em>id</em></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="outcome">Outcome<a href="#outcome" class="hash-link" aria-label="Direct link to Outcome" title="Direct link to Outcome">​</a></h3><p>It took us nearly a month rolling out <strong>90 backend services</strong> and a week enabling the flag for all customers. But the results are very expressive.</p><ul><li>60% Network usage reduction. It&#x27;s been weeks we don&#x27;t have any alerts about Network Bandwidth</li><li>Stable API latencies. We are now able to downsize our infrastructure back to normal levels - we are estimating to downsize REST layer resources by 1/4</li><li>Almost zero&#x27;ed PubSub bandaid network usage. We are now <code>unblocked</code> to remove the <code>bandaid</code> solutions like <code>pubsub-service</code> and <code>sessionless</code> code</li></ul><p>REST Layer p75 to p95 stability and latencies drop after 03/11 - first customers.</p><p><img loading="lazy" alt="rest-latencies" src="/assets/images/rest-latencies-20e1d8d0841730a0294e725627cccbe4.webp" width="1118" height="396" class="img_ev3q"></p><p>Comparing pre-rollout weeks(03/17) to post-rollout (03/17) - Check the end of the graph
<img loading="lazy" alt="monthly-bandwidth-usage" src="/assets/images/monthly-bandwidth-usage-bc6bae758b21a72998e859a3a3727c6e.webp" width="1600" height="797" class="img_ev3q"></p><p>Post-Rollout Monday (Busiest day of week)
<img loading="lazy" alt="busy-monday-after-rollout" src="/assets/images/busy-monday-after-rollout-6b96c54b0c9aeceb789153eabebc0054.webp" width="1600" height="545" class="img_ev3q">
Pre-Rollout Monday (Busiest day of week)
<img loading="lazy" alt="busy-monday-pre" src="/assets/images/busy-monday-pre-39cdb70edf2590a14126621919035305.webp" width="1600" height="523" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="takeaway-points">TakeAway Points<a href="#takeaway-points" class="hash-link" aria-label="Direct link to TakeAway Points" title="Direct link to TakeAway Points">​</a></h2><p>There&#x27;s much more coming in the future - but we are <strong>happy</strong> to finally unblock the road for bigger impact optimizations.</p><p>To build good product, find market-fit, prioritize customers and market requirements is an <code>art of business</code> but I deeply think that there&#x27;s some bounding between business and this <code>not-so-celebrated-kind-of-stuff</code>.</p><p>At the end of the day - delivering a reliable, stable and ever-growing platform requires revisiting past decisions - behind a healthy and stable platform is a great patient experience and efficient staff.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bandwidth">bandwidth</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cost">cost</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/efficient">efficient</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/luma">luma</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/blogpost">blogpost</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2025/03/31/open-source-tales-1">Open Source Tales #1: WebSocket Operator</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-31T00:00:00.000Z" itemprop="datePublished">March 31, 2025</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>One of the most interesting career challenges I&#x27;ve faced was something trivial in the world of <strong>stateless</strong> services but challenging in <strong>stateful</strong> - enabling WebSocket instances to scale horizontally.</p><p>This <strong>challenge</strong> comes in many flavors and ours had some constraints:</p><ul><li>It had to respect our internal framework - listening por model events</li><li>We had to apply IAM filtering</li><li>Had to use SocketIO</li><li>SocketIO plugins like RabbitMQ were not valid. Team judge as costly.</li><li>Redis Plugins were not fit.</li><li>We had to support multi-tab</li><li>No infrastructure involved</li></ul><p>Basically our WebSocket servers ran with old versions of SocketIO and had they very poor usage of its benefits, to say the least. It could&#x27;ve been a simple WebSocket server.</p><p>To scale it horizontally, we decided to use Redis PubSub - by simply allowing clients-server communicate via Redis PubSub.</p><p><img loading="lazy" alt="thumbnail-ws-operator-blogpost" src="/assets/images/thumbnail-ws-operator-blogpost-9370f75714fb48ffa5307fbbc51183cd.webp" width="1024" height="1024" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="end-of-project-and-i-learned-something-very-important">End of Project and I learned something very important<a href="#end-of-project-and-i-learned-something-very-important" class="hash-link" aria-label="Direct link to End of Project and I learned something very important" title="Direct link to End of Project and I learned something very important">​</a></h3><p>And that is <code>choosing to scale WebSocket</code> was a bad idea by itself. As intrinsic to distributed systems, problems like:</p><ul><li>Observability</li><li>Redis PubSub deliverability issues and Network bandwidth</li><li>It lacked re-balancing connections - hot replicas vs cold replicas by amount of conns.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but-i-had-so-many-limitations-that-i-crossed-my-mind">But I had so many limitations that I crossed my mind:<a href="#but-i-had-so-many-limitations-that-i-crossed-my-mind" class="hash-link" aria-label="Direct link to But I had so many limitations that I crossed my mind:" title="Direct link to But I had so many limitations that I crossed my mind:">​</a></h3><p>What If I could just use the underlying environment - aka Kubernetes - for this kind of stuff? Some refined load balancing? Proper routing of messages via proxy? <strong>(TBH a simple RMQ would&#x27;ve done the job so far)</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="considering-that-i-never-ever-stopped-dreaming-about-a-better-design-for-this-problem">Considering that I never-ever stopped dreaming about a better design for this problem<a href="#considering-that-i-never-ever-stopped-dreaming-about-a-better-design-for-this-problem" class="hash-link" aria-label="Direct link to Considering that I never-ever stopped dreaming about a better design for this problem" title="Direct link to Considering that I never-ever stopped dreaming about a better design for this problem">​</a></h3><p>By consequence 2y ears later I stumbled upon <a href="https://medium.com/lumen-engineering-blog/how-to-implement-a-distributed-and-auto-scalable-websocket-server-architecture-on-kubernetes-4cc32e1dfa45" target="_blank" rel="noopener noreferrer">this article</a> which described - beautifully - how they solved scalability for a WebSocket stateful app.</p><p>It motivated me into a <em>crazy journey</em>: <code>If I solved the same issue, if they solved the same issue and we had similar ideas. How many people are solving this same challenge?</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-you-websocket-operator">Introducing you <a href="https://github.com/lukas8219/websocket-operator" target="_blank" rel="noopener noreferrer">websocket-operator</a><a href="#introducing-you-websocket-operator" class="hash-link" aria-label="Direct link to introducing-you-websocket-operator" title="Direct link to introducing-you-websocket-operator">​</a></h3><p><img loading="lazy" alt="ws-operator-poc-diagram" src="/assets/images/ws-operator-poc-diagram-d2ea4bae3f4e4efc48ba53ae4744a822.webp" width="1536" height="1024" class="img_ev3q"></p><p>In this blueprint and <code>not-yet-prod-deployed-oss-project</code> I&#x27;ve mixed two main ingredients:</p><ul><li>The need to learn heavier GO and Kubernetes Operator.</li><li>A problem I&#x27;ve already solved - but now with no limitations</li></ul><p>The Operator consists of three main components - and yes they are very similar to those from the article.</p><ul><li>A LoadBalancer<ul><li>A end-user exposed API that accepts connections and routes to proper proxy-sidecars.</li><li>It applies a distributed load balancing algorithm - shared with the <code>Proxy SideCar</code></li><li>It uses a Kubernetes Service Discovery to check for available IP&#x27;s to load-balancer.</li></ul></li><li>Proxy SideCar<ul><li>Intercept WS Messages and proxies via HTTP to another <code>Proxy SideCar</code> that may have the connection for such recipient.</li><li>It shares the same algorithm from LoadBalancer - they can find themselves</li></ul></li><li>Controller<ul><li>Injects the SideCar in Deployments/Pods with <code>ws.operator/enabled</code> label</li><li>Re-Balances connected users.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="roadmap">Roadmap<a href="#roadmap" class="hash-link" aria-label="Direct link to Roadmap" title="Direct link to Roadmap">​</a></h3><p>This is pretty much inspired in the articles <code>Signaling Servers</code> design and has some interesting features in the Roadmap:</p><ul><li>Pluggable Hashing Algorithm for Routing<ul><li>Plug your own algorithm to load balance connections</li></ul></li><li>Pluggable Routing<ul><li>v0.0.1 will assume WS is exchanging JSON messages - but they could be RAW binaries, or just simple text with their own protocol.</li></ul></li><li>Support Broadcasting</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="takeaway">TakeAway<a href="#takeaway" class="hash-link" aria-label="Direct link to TakeAway" title="Direct link to TakeAway">​</a></h3><ul><li>There&#x27;s a intelectual value in reinventing the wheel</li><li>Do not scale <strong>stateful apps</strong> unless very needed</li><li>And if you need, reconsider it again. You might be safer just oversizing infrastructure</li><li>Ok, you really need it. Study, investigate, research and well, feel free to benchmark this plug and play solution.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/websocket">websocket</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/blogpost">blogpost</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2024/03/15/redis-is-more-than-cache-data-reference">Redis is more than a Cache - Data Reference</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-15T00:00:00.000Z" itemprop="datePublished">March 15, 2024</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Some weeks ago, we had a incident that was caused mainly due to how we delay job execution.
One queue had abnormal behavior during the weekends, which our monitoring systems caught, but we were expecting system to be self-healing and be able to kick through this small hiccup.
Tuesday we noticed something was off with our integration systems - where a code that was running for more than a year stopped working at the same time we rolled it for a new big customer.</p><p>I got involved early in the incident due to how often I touch that component of the backend and we initiated investigation so we could get back to the customer as fast as possible with some good news.</p><p>After some hours of investigation we ended up concluding that our long polling mechanism had a hot-loop on a certain queue - which in turn was always retrying delays. The first time this edge case was triggered happened during the weekends where we saw the previous abnormal behavior.
Due to always re-delaying jobs,  the amount of postponed jobs to this queue would never actually drain and thus this component  would eternally get stuck while trying to drain postponed jobs - delaying all the other queues from the platform.</p><p>In a quick <code>1/2</code> hour solution we shipped code to stop retrying jobs after more than N retries and unblocking the hot loop.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-the-future">What about the future?<a href="#what-about-the-future" class="hash-link" aria-label="Direct link to What about the future?" title="Direct link to What about the future?">​</a></h3><p>All that to say <em>what</em>? What is has to do with Redis? </p><p>As described the previous post from this series - the job delaying mechanism lives within Redis where we use a Sorted Set to pull the next job. We fanout to a certain amount in parallel - but we only restart this processing after all possible queue targets were drained up until some upper bound timestamp (being the <code>score</code> in a SortedSet). </p><p>With this fragility in mind and the upcoming code-freeze of December - I suggested to rewrite this design completely.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="current-design">Current Design<a href="#current-design" class="hash-link" aria-label="Direct link to Current Design" title="Direct link to Current Design">​</a></h3><p>Whenever a service requests an postpone - which can be either <code>intentionally</code> - calling the method to postpone it OR <code>unintentionally</code> - due to some <em>IO failure, protocol error or some ephemeral channel churn</em> - the job flows through this <code>DelayedJobsStorage</code> design.</p><p>The current <code>production</code> design is a simple Sorted Set from Redis where timestamps are the score and key being the job serialized into string.</p><p>On the infrastructure side, we use a <code>cache.r7g.12xlarge ElastiCache</code> (~300GB 🚨) instance to sustain our load SPIKES - like some instabilities or big customers data. </p><p>In the other end, there&#x27;s a separate backend component <code>Scheduler</code> that is responsible for triggering individual jobs at certain interval. This component triggers a service that runs a long-polling logic until the current timestamp.</p><p><img loading="lazy" alt="delayed-jobs-old-design" src="/assets/images/delayed-jobs-old-design.excalidraw.light-0d36dae811866c62916cf305a7786f14.svg#light" width="1055" height="775" class="img_ev3q">
<img loading="lazy" alt="delayed-jobs-old-design" src="/assets/images/delayed-jobs-old-design.excalidraw.dark-fec9955391ae7cb739396fc9ad580aac.svg#dark" width="1055" height="775" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-design">New Design<a href="#new-design" class="hash-link" aria-label="Direct link to New Design" title="Direct link to New Design">​</a></h3><p>I&#x27;ve created some abstractions to make it easier to implement new storage backends like <code>S3</code>, <code>VFS</code> and <em>many more</em>.
<code>Redis</code> is now running as a mainly as reference-to-data component and only stores entire jobs if they are within the next ~2 seconds or some failure happens.</p><p>The storage rationale happens with a couple considerations:</p><ul><li>How long are we planning to postpone?</li><li>How big (byte size) is this job?</li><li>Is this storage backend rolled out for certain queue OR tenant _id?</li><li>Is this storage available? If not, fall back to Redis</li></ul><p>We also changed the core logic behind the backend service that re-enqueues delayed jobs:</p><ul><li><strong><em>Removed the coupling with Scheduler</em>:</strong> <ul><li>Instead of waiting for some schedule job trigger the backend service, it triggers itself given a certain interval.</li></ul></li><li><strong><em>Circuit Breaking</em>:</strong><ul><li>Jobs keeps being re-enqueued up to a certain timeout. Preventing one cycle of starving resources OR locking entire service in some hot-loop.</li></ul></li><li><strong><em>Concurrent Processing with Semaphores</em>:</strong><ul><li>We would always have up to N concurrent processing target queues - decoupled from other executions.</li><li>Speeds up draining time.</li></ul></li><li><strong><em>Better visibility</em>:</strong><ul><li>We implemented proper monitoring such as latencies for each re-enqueue, amount of re-enqueues and failure/successful re-enqueues.</li></ul></li><li><strong>*Horizontally Scale by Controlling the ZPOPMIN:</strong><ul><li>Pop the least score up to an upper-bound timestamp.</li><li>This enables us to have multiple instances running which we were unable in the past due to the Singleton Design we had.</li></ul></li></ul><p><img loading="lazy" alt="new-design" src="/assets/images/new-design.excalidraw.light-48d7ce8ca90f97614b1231fc2a44f0a6.svg#light" width="3636" height="1894" class="img_ev3q">
<img loading="lazy" alt="new-design" src="/assets/images/new-design.excalidraw.dark-899ce2c32ce6e28afa220b258a31ea7a.svg#dark" width="3636" height="1894" class="img_ev3q"></p><p><img loading="lazy" alt="redis-is-more-than-cache-data-reference-new-design-read_" src="/assets/images/redis-is-more-than-cache-data-reference-new-design-read_.excalidraw.light-092399f802a23ff3fc8fd2b5e88a28e6.svg#light" width="3621" height="2217" class="img_ev3q">
<img loading="lazy" alt="redis-is-more-than-cache-data-reference-new-design-read_" src="/assets/images/redis-is-more-than-cache-data-reference-new-design-read_.excalidraw.dark-e0b193bbf14e87d6a51f3c503c9494b5.svg#dark" width="3621" height="2217" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h4><p>Lets use for example - storing a job for 10minutes that has a medium size due to the context it needs to carry. We would store the job data into S3 then insert a key into Redis formatted as <code>s3::some-queue::384192393192::&lt;some-generated-uui&gt;</code>
When trying to re-enqueue the job - the abstraction easily understands the protocol as being <code>s3</code>.  This abstraction then uses the implementation of <code>s3</code> which knows where to fetch a certain job by this <code>uuid</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-to-expect-from-this-design">What to expect from this Design<a href="#what-to-expect-from-this-design" class="hash-link" aria-label="Direct link to What to expect from this Design" title="Direct link to What to expect from this Design">​</a></h3><ul><li><strong>Infrastructure downsizing:</strong> From <code>300GB</code> to <code>&gt;10GB</code><ul><li>Currently we have <code>4million</code> of keys stored consuming up to <code>200GB</code> of RAM</li><li>In the new design this would be <code>~64mb</code> - if we calculate <code>uuid</code> being 128bits and omit the other small appended data.</li><li>Roughly we are expecting to downsize to <code>10GB</code> - since brief postpones can still occurs and overload it. <em>Experimentation</em> will lead us to decide the proper size.</li></ul></li><li><strong>Independency:</strong> <em>Decouple backend components preventing service A stopping service B of working properly</em></li><li><strong>Speed:</strong> <em>N replicas will consume queues much faster in some abnormal load</em></li><li><strong>Horizontal Scalability/Reliability:</strong> Multiple Consuming replicas.</li><li><strong>Tail-Latency Aware:</strong> Latency-Sensitive components will be decoupled such as WebSocket notifications, Chat Messages and all real time communication - heavily used in the platform</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="concerns">Concerns<a href="#concerns" class="hash-link" aria-label="Direct link to Concerns" title="Direct link to Concerns">​</a></h3><ul><li>RPS - How many jobs are being delayed per sec and their latencies? p75, p90, p99</li><li>S3 speed for large objects -&gt; Will it impact our re-enqueueing speed?</li><li>Proper Redis sizing -&gt; How far can we push lower?</li><li>Redis is still a single point of failure -&gt; What if Redis just <strong>dies</strong>?</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/delayed-jobs">delayed-jobs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pubsub">pubsub</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/distributed-systems">distributed-systems</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/semaphores">semaphores</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/async-generators">async-generators</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nodejs">nodejs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/readisismorethanacache">readisismorethanacache</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2024/03/15/redis-is-more-than-cache-job-delay">Redis is more than a Cache - Delaying Jobs</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-15T00:00:00.000Z" itemprop="datePublished">March 15, 2024</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>My current company - <a href="https://www.lumahealth.io/" target="_blank" rel="noopener noreferrer">Luma Health Inc</a> - has an <code>Event-Driven Architecture</code> where all of our backend systems interact via async messaging/jobs. Thus our backbone is sustained by an AMQP broker - RabbitMQ - which routes the jobs to interested services.</p><p>Since our jobs are very critical - we cannot support failures AND should design to make the system more resilient because well..we don&#x27;t want a patient not being notified of their appointment, appointments not being created when they should, patients showing off into facilities where they were never notified the patient had something scheduled.</p><p>Besides the infra and product reliability - some use cases could need postponing - maybe reaching out to an external system who&#x27;s offline/or not responding. Maybe some error which needs a retry - who knows? </p><p>The fact is, delaying/retry is a very frequent requirement into Event Driven Architectures. With this a service responsible for doing it was created - and it worked fine.</p><p>But - as the company sold bigger contracts and grew up in scale - this system was almost stressed out and not reliable.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-unreliable-design">The Unreliable Design<a href="#the-unreliable-design" class="hash-link" aria-label="Direct link to The Unreliable Design" title="Direct link to The Unreliable Design">​</a></h2><p>Before giving the symptoms, let&#x27;s talk about the organism itself - the service old design.</p><p>The design was really straightforward - if our service handlers asked for a postpone OR we failed to send the message to RabbitMQ - we just insert the JSON object from the Job into a Redis <code>Sorted Set</code> and using the <code>Score</code> as the timestamp which it was meant to be retried/published again.</p><p>To publish back into RabbitMQ the postponed messages, a job would be triggered each 5 seconds - doing the following:</p><ol><li>Read from a <code>set</code> key containing all the existing <code>sorted set</code> keys - basically the queue name</li><li>Fetch jobs using <code>zrangebyscore</code> from 0 to current timestamp BUT <code>limit</code> to 5K jobs.</li><li>Publish the job to RabbitMQ and remove it from <code>sorted set</code></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-issues">The Issues<a href="#the-issues" class="hash-link" aria-label="Direct link to The Issues" title="Direct link to The Issues">​</a></h2><p>This solution actually scaled up until 1-2 years ago when we started having issues with it - the main one&#x27;s being:</p><ol><li>It could not catch up to a huge backlog of delayed messages</li><li>It would eventually OOM or SPIKE up to 40GB of memory<ol><li>Due to things being fetched into memory AND some instability OR even some internal logic - we could end up shoveling too much data into Redis - the service just died 💀</li></ol></li><li>We could not scale horizontally - due to consuming and fetching objects into memory before deleting them.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-solution">The Solution<a href="#the-solution" class="hash-link" aria-label="Direct link to The Solution" title="Direct link to The Solution">​</a></h2><p>The solution was very simple: we implemented something that I liked to call <code>streaming approach</code></p><p>Using the same data structure, we are now:</p><ol><li>Running a <code>zcount</code> from 0 to current timestamp<ul><li>Counting the amount of Jobs -&gt; returning N</li></ul></li><li>Creating an <code>Async Iterator</code> for N times - that used the <code>zpopmin</code> method from Redis<ul><li><code>zpopmin</code> basically returns AND removes the least score object - ie most recent timestamp</li></ul></li></ol><p>The <code>processor</code> for the SortedSet
<img loading="lazy" alt="process-delayed-jobs-code" src="/assets/images/process-delayed-jobs-code-591f517b1c2b562610332d2ca1d4fe0a.webp" width="1265" height="176" class="img_ev3q"></p><p>The <code>Async Iterator</code>
<img loading="lazy" alt="job-scan-iterator" src="/assets/images/job-scan-iterator-2eee4c5e3c189778e503a58277713b8d.webp" width="997" height="397" class="img_ev3q"></p><p>And that&#x27;s all!</p><p>This simple algorithm change annihilated the need for:</p><ol><li>Big In Memory fetches - makes our memory allocation big</li><li>Limit of 5K in fetches - makes our throughput lower</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="results---which-i-think-the-screenshots-can-speak-for-themselves">Results - <em>which I think the screenshots can speak for themselves</em><a href="#results---which-i-think-the-screenshots-can-speak-for-themselves" class="hash-link" aria-label="Direct link to results---which-i-think-the-screenshots-can-speak-for-themselves" title="Direct link to results---which-i-think-the-screenshots-can-speak-for-themselves">​</a></h2><p><em>We processed the entire backlog of 40GB of pending jobs pretty quickly</em>
<img loading="lazy" alt="aws-memory-consumption" src="/assets/images/aws-memory-consumption-7da343038548b77a8337cc857dc8ba7d.webp" width="2196" height="764" class="img_ev3q"></p><p> <em>From a constant usage of ~8GB - we dropped down to ~200MB</em>
<img loading="lazy" alt="memory-delayed-jobs" src="/assets/images/memory-delayed-jobs-3c83db027a49a945ce8606ff0a8c7fde.webp" width="2128" height="538" class="img_ev3q">
<em>We are now - trying to be play safe and still oversize - safely allocating 1/4 of the resources.</em> The git diff was our first resource dump - we went even further.</p><p><img loading="lazy" alt="git-diff-memory-delayed-jobs" src="data:image/webp;base64,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" width="268" height="215" class="img_ev3q"></p><p>Money-wise: We are talking at least of 1K USD/month AND more in the future if we can lower our ElastiCache instance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="take-away-points">Take Away Points<a href="#take-away-points" class="hash-link" aria-label="Direct link to Take Away Points" title="Direct link to Take Away Points">​</a></h2><ul><li>Redis is a Distributed DataStructure database - more than just a simply KeyValue pair storage.</li><li>You can achieve great designs using Redis</li><li>Be careful because the way you design a solution with Redis may be costly in the future</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-thoughts">Final Thoughts<a href="#final-thoughts" class="hash-link" aria-label="Direct link to Final Thoughts" title="Direct link to Final Thoughts">​</a></h2><p>There could be a lot of discussion wether this is a great way of doing jobs postponing, if Redis is the right storage, if we should really postpone jobs for small network hiccups, shouldn&#x27;t we leverage DelayedExchange from Rabbit? - etc...
But at the end of the day - to succeed as a company we need to solve problems in our daily routine. Some problems are worth, some are not. It&#x27;s always - one step at a time.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/jobs">jobs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pubsub">pubsub</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/luma">luma</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/more">more</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/than">than</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cache">cache</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/readisismorethanacache">readisismorethanacache</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2024/03/15/zalgo-effect-resource-leakage">The Zalgo Effect and Resource Leakage - A Case</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-15T00:00:00.000Z" itemprop="datePublished">March 15, 2024</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Zalgo Effect is an term used to describe unexpected outcomes of mixing <code>sync</code> and <code>async</code> javascript code.</p><p>It means - if you mix these two approaches SOMETHING weird will happen.</p><p>It&#x27;s one of those things you kinda <em>don&#x27;t understand</em> until you see it in real production systems.</p><h1>So what it has to do with Resource Leakage?</h1><p>One day, our SRE team received a couple PagerDuty alerts claiming our services were restarting and not able to work properly due to <code>Error: No channels left to allocate</code> - ie RabbitMQ connections were maxing out in channel allocation. (For RabbitMQ reference into Channels and Connections)</p><p>It was clear some code was leaking channel creations. No one knew what could potentially be - but God I had studied this <code>Zalgo Effect</code> in <code>NodeJS Design Patterns</code> Book and it clicked me something.</p><h1>How was I so sure the Zalgo was the culprit?</h1><p>The service that was throwing that error was only responsible for fan out a couple messages to a lot of other services - so it was easy as creating a <code>Queue</code> object and running N promises concurrently to publish some message.
Checking the RabbitMQ Management UI showed me that we created N channels for that connection.</p><h1>But why it only happened in some scenarios?</h1><p>That&#x27;s where the <code>Zalgo Effect</code> pops in.</p><p>Our code was built back in ~2015 - Node 4. The callback style was the mainstream. Our Engineers created the abstraction <code>Queue</code> which dealt with almost 50% of our Event-Driven Architecture by itself and had to make the <code>class</code> style w/ async initializations - not so easily with callbacks.</p><p>So the code assumed the following:</p><ol><li>Assert exchange, queues and necessary resources - via something we could call <code>consumeChannel</code>.<ol><li>The consume channel is created whenever the connection is made.</li></ol></li><li>Our <code>confirmChannel</code> - ie the channel we used to <code>publish</code> events was lazily created - mixing <code>async</code> and <code>sync</code> code.</li></ol><p>So the problem lives in 2).</p><p>Imagine the following:</p><ul><li>We <code>assertConfirmChannel</code><img loading="lazy" alt="old-assert-confirm" src="/assets/images/old-assert-confirm-8a21da4bb68e7ae7f2d355388a8a8a4d.webp" width="995" height="113" class="img_ev3q"><img loading="lazy" alt="old-get-instance" src="/assets/images/old-get-instance-24b7afc5993aeba0f081985202d20afa.webp" width="1050" height="211" class="img_ev3q"></li><li>It check&#x27;s whether the channel EXISTS or NOT.</li><li>If not, create via <code>PROMISE</code> and return control to EventLoop</li><li>If does, return it</li></ul><p>What happens, if the <code>two concurrent promises</code> reaches the same <code>if</code> without the first promise resolving? We try to create the channel two times and override them - thus keeping channels open but just using only the last one.</p><p>This is where the code was <em>leaking</em> channels.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fixing-the-problem">Fixing the problem<a href="#fixing-the-problem" class="hash-link" aria-label="Direct link to Fixing the problem" title="Direct link to Fixing the problem">​</a></h2><p>Well, the fix we <em>actually shipped</em> was simply calling 1 Promise and await it and then fan out the other promises.</p><p>But we made it simple due to risks and since the code is being refactored into a new style.</p><h1>How can I fix If I see something like that?</h1><p>If you want a real solution, here&#x27;s what the V2 would look like - the idea is to create Promises and assign variables with them, instead of doing <code>await</code> on it. Example as below:</p><p><img loading="lazy" alt="assert-zalgo" src="/assets/images/assert-zalgo-307baf5abd886e4c3cc7e39d5203e33f.webp" width="853" height="197" class="img_ev3q"></p><p>This easily fixes the problem - by setting a variable as promise and checking its existence.</p><p>A more robust style, where you actually need to initialize a couple of resources, you could do something like below</p><p><img loading="lazy" alt="get-or-create-client-print" src="/assets/images/get-or-create-client-print-86ec69f70ed8bcf441bbb64549391b1e.webp" width="903" height="741" class="img_ev3q"></p><ol><li>Create a function to execute the entire Promise.</li><li>Set up some reference to it</li><li>If requested the same, just use the same Promise.</li></ol><h1>Ok - but why it fixes the problem?</h1><p>The idea is to make sure - we are running things in a sync manner and just making the promises settled on their timing. We need to think about the synchronous code execution block to reason about our promises usage.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nodejs">nodejs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/zalgoeffect">zalgoeffect</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/code">code</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/12/24/nodejs-101-lazy-init">NodeJS 101 -  Lazy Initialization</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-24T00:00:00.000Z" itemprop="datePublished">December 24, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lukas8219.png" alt="Lucas Weis Polesello"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lukas8219" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lucas Weis Polesello</span></a></div><small class="avatar__subtitle" itemprop="description">SRE | Senior Software Engineer @ LumaHealth</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>One of the main challenges when dealing w/ the async nature of NodeJS is initializing classes/clients that requires some sort of side effect - such as database connection, disk reads or whatsoever. Even the simple idea of waiting for the first use-case to connect/initialize a resource.</p><p>Besides Dependency Injection - I like to use two approaches for this:</p><p>1) Leaving it up to the client to call <code>connect</code> or any other synonym - easy as creating an <code>async function</code> as the example below</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> redis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;redis&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> crypto </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;crypto&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//PROS: Damn easy, simple and straight-forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//CONS: This leaves the entire responsibility to the client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DistributedDataStructure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">staffName</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> reviewId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//Do some business here - idk,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> accountName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">sAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">v1:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">accountName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:pending-reviews</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reviewId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DistributedDataStructure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Jerome&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">randomBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;hex&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2) Proxying the access</p><p>In the real and wild-world we know that we have to deal w/ legacy code, legacy initialization methods and much more unexpected stuff - for this we have a second use-case which leverages the (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy%5D)%5BProxy" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy])[Proxy</a> API for JS]</p><p>Using Proxy it would look poorly-like</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> redis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;redis&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> once </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;events&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> crypto </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;crypto&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//PROS: No client responsibility - makes it easy for the client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//CONS: More complex and error prone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ProxiedDistributedDataStructure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> descriptor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">descriptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">isReady</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> descriptor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">once</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ready&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> descriptor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">staffName</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> reviewId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//Do some business here - idk - like below</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> accountName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">staffName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">sAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">v1:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">accountName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:pending-reviews</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reviewId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ProxiedDistributedDataStructure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Jerome&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">randomBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;hex&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The main benefit for the second approach is that we can instantiate the objects in <code>sync</code> contexts and only treat the method calls as <code>async</code>  -  instead of needing to play around some dirty gimmicks to call <code>connect</code> and chain promises - even worse, callbackifying.</p><p><strong>NOTES</strong>: AFAIC from Redis V3^ we have an option <code>legacyMode</code> whenever creating the client which we can keep this lazy nature of Redis - doing client buffering of calls.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nodejs">nodejs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/lazyinitialization">lazyinitialization</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nodejs-101">nodejs101</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/node">node</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 LWP Softwares. MIT</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4932596a.js"></script>
<script src="/assets/js/main.846843c0.js"></script>
</body>
</html>