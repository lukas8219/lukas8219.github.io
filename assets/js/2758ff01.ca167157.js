"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7430],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(a),m=r,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||o;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},20774:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const o={title:"Open Source Tales #1: WebSocket Operator",authors:"lukas8219",tags:["websocket","blogpost"]},i=void 0,l={permalink:"/blog/2025/03/31/open-source-tales-1",source:"@site/blog/2025-03-31/open-source-tales-1.md",title:"Open Source Tales #1: WebSocket Operator",description:"One of the most interesting career challenges I've faced was something trivial in the world of stateless services but challenging in stateful - enabling WebSocket instances to scale horizontally.",date:"2025-03-31T00:00:00.000Z",formattedDate:"March 31, 2025",tags:[{label:"websocket",permalink:"/blog/tags/websocket"},{label:"blogpost",permalink:"/blog/tags/blogpost"}],readingTime:2.95,hasTruncateMarker:!1,authors:[{name:"Lucas Weis Polesello",title:"SRE | Senior Software Engineer @ LumaHealth",url:"https://github.com/lukas8219",email:"lucas.polesello@lwpsoftwares.com | lucas.c4d@gmail.com",socials:{x:"https://x.com/luucaspole"},imageURL:"https://github.com/lukas8219.png",key:"lukas8219"}],frontMatter:{title:"Open Source Tales #1: WebSocket Operator",authors:"lukas8219",tags:["websocket","blogpost"]},prevItem:{title:"The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations",permalink:"/blog/2025/03/31/network-bandwidth-reduction"},nextItem:{title:"Redis is more than a Cache - Data Reference",permalink:"/blog/2024/03/15/redis-is-more-than-cache-data-reference"}},s={authorsImageUrls:[void 0]},p=[{value:"End of Project and I learned something very important",id:"end-of-project-and-i-learned-something-very-important",level:3},{value:"But I had so many limitations that I crossed my mind:",id:"but-i-had-so-many-limitations-that-i-crossed-my-mind",level:3},{value:"Considering that I never-ever stopped dreaming about a better design for this problem",id:"considering-that-i-never-ever-stopped-dreaming-about-a-better-design-for-this-problem",level:3},{value:"Introducing you websocket-operator",id:"introducing-you-websocket-operator",level:3},{value:"Roadmap",id:"roadmap",level:3},{value:"TakeAway",id:"takeaway",level:3}],u={toc:p},c="wrapper";function d(e){let{components:t,...o}=e;return(0,r.kt)(c,(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"One of the most interesting career challenges I've faced was something trivial in the world of ",(0,r.kt)("strong",{parentName:"p"},"stateless")," services but challenging in ",(0,r.kt)("strong",{parentName:"p"},"stateful")," - enabling WebSocket instances to scale horizontally."),(0,r.kt)("p",null,"This ",(0,r.kt)("strong",{parentName:"p"},"challenge")," comes in many flavors and ours had some constraints:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"It had to respect our internal framework - listening por model events"),(0,r.kt)("li",{parentName:"ul"},"We had to apply IAM filtering"),(0,r.kt)("li",{parentName:"ul"},"Had to use SocketIO"),(0,r.kt)("li",{parentName:"ul"},"SocketIO plugins like RabbitMQ were not valid. Team judge as costly."),(0,r.kt)("li",{parentName:"ul"},"Redis Plugins were not fit."),(0,r.kt)("li",{parentName:"ul"},"We had to support multi-tab"),(0,r.kt)("li",{parentName:"ul"},"No infrastructure involved")),(0,r.kt)("p",null,"Basically our WebSocket servers ran with old versions of SocketIO and had they very poor usage of its benefits, to say the least. It could've been a simple WebSocket server."),(0,r.kt)("p",null,"To scale it horizontally, we decided to use Redis PubSub - by simply allowing clients-server communicate via Redis PubSub."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"thumbnail-ws-operator-blogpost",src:a(53423).Z,width:"1024",height:"1024"})),(0,r.kt)("h3",{id:"end-of-project-and-i-learned-something-very-important"},"End of Project and I learned something very important"),(0,r.kt)("p",null,"And that is ",(0,r.kt)("inlineCode",{parentName:"p"},"choosing to scale WebSocket")," was a bad idea by itself. As intrinsic to distributed systems, problems like:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Observability"),(0,r.kt)("li",{parentName:"ul"},"Redis PubSub deliverability issues and Network bandwidth"),(0,r.kt)("li",{parentName:"ul"},"It lacked re-balancing connections - hot replicas vs cold replicas by amount of conns.")),(0,r.kt)("h3",{id:"but-i-had-so-many-limitations-that-i-crossed-my-mind"},"But I had so many limitations that I crossed my mind:"),(0,r.kt)("p",null,"What If I could just use the underlying environment - aka Kubernetes - for this kind of stuff? Some refined load balancing? Proper routing of messages via proxy? ",(0,r.kt)("strong",{parentName:"p"},"(TBH a simple RMQ would've done the job so far)")),(0,r.kt)("h3",{id:"considering-that-i-never-ever-stopped-dreaming-about-a-better-design-for-this-problem"},"Considering that I never-ever stopped dreaming about a better design for this problem"),(0,r.kt)("p",null,"By consequence 2y ears later I stumbled upon ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/lumen-engineering-blog/how-to-implement-a-distributed-and-auto-scalable-websocket-server-architecture-on-kubernetes-4cc32e1dfa45"},"this article")," which described - beautifully - how they solved scalability for a WebSocket stateful app."),(0,r.kt)("p",null,"It motivated me into a ",(0,r.kt)("em",{parentName:"p"},"crazy journey"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"If I solved the same issue, if they solved the same issue and we had similar ideas. How many people are solving this same challenge?")),(0,r.kt)("h3",{id:"introducing-you-websocket-operator"},"Introducing you ",(0,r.kt)("a",{parentName:"h3",href:"https://github.com/lukas8219/websocket-operator"},"websocket-operator")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"ws-operator-poc-diagram",src:a(7180).Z,width:"1536",height:"1024"})),(0,r.kt)("p",null,"In this blueprint and ",(0,r.kt)("inlineCode",{parentName:"p"},"not-yet-prod-deployed-oss-project")," I've mixed two main ingredients:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The need to learn heavier GO and Kubernetes Operator."),(0,r.kt)("li",{parentName:"ul"},"A problem I've already solved - but now with no limitations")),(0,r.kt)("p",null,"The Operator consists of three main components - and yes they are very similar to those from the article."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A LoadBalancer",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"A end-user exposed API that accepts connections and routes to proper proxy-sidecars."),(0,r.kt)("li",{parentName:"ul"},"It applies a distributed load balancing algorithm - shared with the ",(0,r.kt)("inlineCode",{parentName:"li"},"Proxy SideCar")),(0,r.kt)("li",{parentName:"ul"},"It uses a Kubernetes Service Discovery to check for available IP's to load-balancer."))),(0,r.kt)("li",{parentName:"ul"},"Proxy SideCar",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Intercept WS Messages and proxies via HTTP to another ",(0,r.kt)("inlineCode",{parentName:"li"},"Proxy SideCar")," that may have the connection for such recipient."),(0,r.kt)("li",{parentName:"ul"},"It shares the same algorithm from LoadBalancer - they can find themselves"))),(0,r.kt)("li",{parentName:"ul"},"Controller",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Injects the SideCar in Deployments/Pods with ",(0,r.kt)("inlineCode",{parentName:"li"},"ws.operator/enabled")," label"),(0,r.kt)("li",{parentName:"ul"},"Re-Balances connected users.")))),(0,r.kt)("h3",{id:"roadmap"},"Roadmap"),(0,r.kt)("p",null,"This is pretty much inspired in the articles ",(0,r.kt)("inlineCode",{parentName:"p"},"Signaling Servers")," design and has some interesting features in the Roadmap:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Pluggable Hashing Algorithm for Routing",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Plug your own algorithm to load balance connections"))),(0,r.kt)("li",{parentName:"ul"},"Pluggable Routing",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"v0.0.1 will assume WS is exchanging JSON messages - but they could be RAW binaries, or just simple text with their own protocol."))),(0,r.kt)("li",{parentName:"ul"},"Support Broadcasting")),(0,r.kt)("h3",{id:"takeaway"},"TakeAway"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"There's a intelectual value in reinventing the wheel"),(0,r.kt)("li",{parentName:"ul"},"Do not scale ",(0,r.kt)("strong",{parentName:"li"},"stateful apps")," unless very needed"),(0,r.kt)("li",{parentName:"ul"},"And if you need, reconsider it again. You might be safer just oversizing infrastructure"),(0,r.kt)("li",{parentName:"ul"},"Ok, you really need it. Study, investigate, research and well, feel free to benchmark this plug and play solution.")))}d.isMDXComponent=!0},53423:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/thumbnail-ws-operator-blogpost-9370f75714fb48ffa5307fbbc51183cd.webp"},7180:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/ws-operator-poc-diagram-d2ea4bae3f4e4efc48ba53ae4744a822.webp"}}]);