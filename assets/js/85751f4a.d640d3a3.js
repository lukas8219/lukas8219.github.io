"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3789],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>h});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=u(a),m=o,h=c["".concat(l,".").concat(m)]||c[m]||p[m]||i;return a?n.createElement(h,r(r({ref:t},d),{},{components:a})):n.createElement(h,r({ref:t},d))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:o,r[1]=s;for(var u=2;u<i;u++)r[u]=a[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},33953:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var n=a(87462),o=(a(67294),a(3905));const i={title:"The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations",authors:"lukas8219",tags:["redis","bandwidth","cost","efficient","luma","blogpost"]},r=void 0,s={permalink:"/blog/2025/03/31/network-bandwidth-reduction",source:"@site/blog/2025-03-31/network-bandwidth-reduction.md",title:"The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations",description:"Back in 2022 @Luma had a major outage which caused hours of downtime, angry customers and lots of engineering efforts to return the product back to normal.",date:"2025-03-31T00:00:00.000Z",formattedDate:"March 31, 2025",tags:[{label:"redis",permalink:"/blog/tags/redis"},{label:"bandwidth",permalink:"/blog/tags/bandwidth"},{label:"cost",permalink:"/blog/tags/cost"},{label:"efficient",permalink:"/blog/tags/efficient"},{label:"luma",permalink:"/blog/tags/luma"},{label:"blogpost",permalink:"/blog/tags/blogpost"}],readingTime:3.94,hasTruncateMarker:!1,authors:[{name:"Lucas Weis Polesello",title:"SRE | Senior Software Engineer @ LumaHealth",url:"https://github.com/lukas8219",email:"lucas.polesello@lwpsoftwares.com | lucas.c4d@gmail.com",socials:{x:"https://x.com/luucaspole"},imageURL:"https://github.com/lukas8219.png",key:"lukas8219"}],frontMatter:{title:"The Tale of How We Compensated Years of Tech Debt in a Month: Performance, Cost and Optimizations",authors:"lukas8219",tags:["redis","bandwidth","cost","efficient","luma","blogpost"]},nextItem:{title:"Open Source Tales #1: WebSocket Operator",permalink:"/blog/2025/03/31/open-source-tales-1"}},l={authorsImageUrls:[void 0]},u=[{value:"inb4: PHI",id:"inb4-phi",level:2},{value:"IAM Model",id:"iam-model",level:2},{value:"What&#39;s the problem of it?",id:"whats-the-problem-of-it",level:3},{value:"Infrastructure Impact",id:"infrastructure-impact",level:3},{value:"The Business Impact? Money being thrown away and unsatisfied customers",id:"the-business-impact-money-being-thrown-away-and-unsatisfied-customers",level:2},{value:"A simple feature flag - that would do <code>Query.select(_id)</code> when querying <code>Groups</code> - building the session with less data.",id:"a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data",level:4},{value:"Rollout and Implementation",id:"rollout-and-implementation",level:3},{value:"Outcome",id:"outcome",level:3},{value:"TakeAway Points",id:"takeaway-points",level:2}],d={toc:u},c="wrapper";function p(e){let{components:t,...i}=e;return(0,o.kt)(c,(0,n.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Back in 2022 ",(0,o.kt)("a",{parentName:"p",href:"https://www.lumahealth.io/"},"@Luma")," had a major outage which caused hours of downtime, angry customers and lots of engineering efforts to return the product back to normal.\nOne of the discoveries made at that time was a hard truth: ",(0,o.kt)("inlineCode",{parentName:"p"},"we modeled our internal IAM object poorly"),"."),(0,o.kt)("h2",{id:"inb4-phi"},"inb4: PHI"),(0,o.kt)("p",null,"On the HealthCare Tech Industry - and outside of it - Patient Health Information (PHI) is of major importance. When applied to Luma's platform - being ",(0,o.kt)("em",{parentName:"p"},"very")," brief - states that patient's data should belong only to facilities that they had interaction with/allowed them to have.\nThis is to protect patient's health information and access to their data. It's a US-government enforced law."),(0,o.kt)("h2",{id:"iam-model"},"IAM Model"),(0,o.kt)("p",null,"Our IAM model is something called ",(0,o.kt)("inlineCode",{parentName:"p"},"session")," object - a pretty simple concept - it concentrates the user's token, settings, groups, facilities and more metadata about itself. We use this ",(0,o.kt)("inlineCode",{parentName:"p"},"session")," throughout all backend components of Luma to properly apply this PHI filtering rule.\nOne of the bad decision back then was to simply pull all ",(0,o.kt)("inlineCode",{parentName:"p"},"facilities")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"groups")," inside a JSON object and cache it. But then you would probably ask..."),(0,o.kt)("h3",{id:"whats-the-problem-of-it"},"What's the problem of it?"),(0,o.kt)("p",null,"When Luma grown it's scale - we started onboarding bigger and bigger customers - with their own setup of account leading to N different use-cases.\nSumming up some very creative account setups and huge customers - we ended up creating something unexpected - ",(0,o.kt)("inlineCode",{parentName:"p"},"session")," object storing up to 2.6MB of pure JSON text."),(0,o.kt)("p",null,"And yes, you did read it right - an entire PDF!!"),(0,o.kt)("p",null,"Now ",(0,o.kt)("inlineCode",{parentName:"p"},"imagine that for each job, we actually pulled cached sessions up to 100x - or even more. Luma produces average of 2K jobs per second spiking up to 10K")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"That's ",(0,o.kt)("inlineCode",{parentName:"strong"},"ALOT")," of Network usage.")," - easily surpassing 2GB per second - aka more than 15Gbps.\nFor reference - ",(0,o.kt)("a",{parentName:"p",href:"https://instances.vantage.sh/aws/elasticache/cache.m6g.8xlarge"},"cache.m6g.8xlarge")," which is a fair-sized cache instance has this bandwidth."),(0,o.kt)("h3",{id:"infrastructure-impact"},"Infrastructure Impact"),(0,o.kt)("p",null,"All of a sudden Luma has this scenario:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Slow and unstable HTTP APIs"),(0,o.kt)("li",{parentName:"ul"},"Had to oversize more than usual to handle same load - a very low overall ~400RPS"),(0,o.kt)("li",{parentName:"ul"},"Had to split our Broker instance into smaller and focused one's"),(0,o.kt)("li",{parentName:"ul"},"Had to increase our cache size"),(0,o.kt)("li",{parentName:"ul"},"We had to create one thing called ",(0,o.kt)("inlineCode",{parentName:"li"},"pubsub-service")," (yes and yes, no bueno) to offload services of slow publishes."),(0,o.kt)("li",{parentName:"ul"},"With this - we also created a ",(0,o.kt)("inlineCode",{parentName:"li"},"jobless")," feature which forced backend components to publish only the ",(0,o.kt)("inlineCode",{parentName:"li"},"jobId")," and route the job content itself via Redis.")),(0,o.kt)("h2",{id:"the-business-impact-money-being-thrown-away-and-unsatisfied-customers"},"The Business Impact? Money being thrown away and unsatisfied customers"),(0,o.kt)("p",null,"Given it's mission-critical importance of ",(0,o.kt)("inlineCode",{parentName:"p"},"Session")," - the risks were just too high until 1st of March 2025.\nAfter good months of investigation, searching code, trying to run AST analysis (codemod) in almost the entire codebase and libraries - it sounded like we had a solution in-mind."),(0,o.kt)("h4",{id:"a-simple-feature-flag---that-would-do-queryselect_id-when-querying-groups---building-the-session-with-less-data"},"A simple feature flag - that would do ",(0,o.kt)("inlineCode",{parentName:"h4"},"Query.select(_id)")," when querying ",(0,o.kt)("inlineCode",{parentName:"h4"},"Groups")," - building the session with less data."),(0,o.kt)("p",null,"Although simple and sustained by a lot of research we were still cautious by setting up lots of product metrics and log metrics to understand wether rolled customers would have negative impact - like messaging not going out, notifications being missed or even worse - entire product breakdown."),(0,o.kt)("h3",{id:"rollout-and-implementation"},"Rollout and Implementation"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"We needed to ensure our libraries were at least a certain version"),(0,o.kt)("li",{parentName:"ul"},"Enable flag for each customer tenant ",(0,o.kt)("em",{parentName:"li"},"id"))),(0,o.kt)("h3",{id:"outcome"},"Outcome"),(0,o.kt)("p",null,"It took us nearly a month rolling out ",(0,o.kt)("strong",{parentName:"p"},"90 backend services")," and a week enabling the flag for all customers. But the results are very expressive."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"60% Network usage reduction. It's been weeks we don't have any alerts about Network Bandwidth"),(0,o.kt)("li",{parentName:"ul"},"Stable API latencies. We are now able to downsize our infrastructure back to normal levels - we are estimating to downsize REST layer resources by 1/4"),(0,o.kt)("li",{parentName:"ul"},"Almost zero'ed PubSub bandaid network usage. We are now ",(0,o.kt)("inlineCode",{parentName:"li"},"unblocked")," to remove the ",(0,o.kt)("inlineCode",{parentName:"li"},"bandaid")," solutions like ",(0,o.kt)("inlineCode",{parentName:"li"},"pubsub-service")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"sessionless")," code")),(0,o.kt)("p",null,"REST Layer p75 to p95 stability and latencies drop after 03/11 - first customers."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"rest-latencies",src:a(4746).Z,width:"1118",height:"396"})),(0,o.kt)("p",null,"Comparing pre-rollout weeks(03/17) to post-rollout (03/17) - Check the end of the graph\n",(0,o.kt)("img",{alt:"monthly-bandwidth-usage",src:a(19287).Z,width:"1600",height:"797"})),(0,o.kt)("p",null,"Post-Rollout Monday (Busiest day of week)\n",(0,o.kt)("img",{alt:"busy-monday-after-rollout",src:a(51710).Z,width:"1600",height:"545"}),"\nPre-Rollout Monday (Busiest day of week)\n",(0,o.kt)("img",{alt:"busy-monday-pre",src:a(40479).Z,width:"1600",height:"523"})),(0,o.kt)("h2",{id:"takeaway-points"},"TakeAway Points"),(0,o.kt)("p",null,"There's much more coming in the future - but we are ",(0,o.kt)("strong",{parentName:"p"},"happy")," to finally unblock the road for bigger impact optimizations."),(0,o.kt)("p",null,"To build good product, find market-fit, prioritize customers and market requirements is an ",(0,o.kt)("inlineCode",{parentName:"p"},"art of business")," but I deeply think that there's some bounding between business and this ",(0,o.kt)("inlineCode",{parentName:"p"},"not-so-celebrated-kind-of-stuff"),"."),(0,o.kt)("p",null,"At the end of the day - delivering a reliable, stable and ever-growing platform requires revisiting past decisions - behind a healthy and stable platform is a great patient experience and efficient staff."))}p.isMDXComponent=!0},51710:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/busy-monday-after-rollout-6b96c54b0c9aeceb789153eabebc0054.webp"},40479:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/busy-monday-pre-39cdb70edf2590a14126621919035305.webp"},19287:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/monthly-bandwidth-usage-bc6bae758b21a72998e859a3a3727c6e.webp"},4746:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/rest-latencies-20e1d8d0841730a0294e725627cccbe4.webp"}}]);